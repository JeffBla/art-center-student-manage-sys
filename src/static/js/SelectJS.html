<script>
  function LoadSelectBoxOption() {
    // Show the loading spinner
    document.getElementById("loading-spinner").style.display = "flex";

    console.log("Loading selection data...");
    // Call the Apps Script function to get the data
    google.script.run.withSuccessHandler(generateSelectBox).getSheetData();
  }

  function generateSelectBox(data) {
    // Hide the loading spinner
    document.getElementById("loading-spinner").style.display = "none";

    // Create the select element
    const select = document.createElement("select");
    select.id = "selectbox";
    select.setAttribute("data-selected", "");
    select.name = "event";

    // Add the default option
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.selected = true;
    defaultOption.disabled = true;
    defaultOption.textContent = "選擇一個活動";
    select.appendChild(defaultOption);

    // Create optgroups and options
    for (const [category, events] of Object.entries(data)) {
      const optgroup = document.createElement("optgroup");
      optgroup.label = category;

      for (const [eventName, eventDetails] of Object.entries(events)) {
        const option = document.createElement("option");
        option.value = eventName;
        option.textContent = eventName;
        optgroup.appendChild(option);
      }

      select.appendChild(optgroup);
    }

    // Insert the select element into the DOM
    const container = document.getElementById("selectbox-container");
    container.innerHTML = ""; // Clear any existing content
    container.appendChild(select);
  }

  // Function to handle event selection
  document.getElementById("selectbox").addEventListener("change", function () {
    const selectedValue = this.value;
    const infoDiv = document.querySelector(".info");
    const loader = infoDiv.querySelector(".loader");
    const noSelection = infoDiv.querySelector(".no-selection");
    const eventInfo = infoDiv.querySelector(".event-info");

    // Set the data-selected attribute to the selected event value
    infoDiv.setAttribute("data-selected", selectedValue);

    // Display loading animation
    infoDiv.classList.add("loading");
    noSelection.style.display = "none";
    eventInfo.style.display = "none";

    // Simulate fetching event details (replace with real data fetching logic if needed)
    setTimeout(() => {
      // Hide loading animation
      infoDiv.classList.remove("loading");

      google.script.run.withSuccessHandler(setInfo).getEventInfo(selectedValue);
    }, 3000); // Simulate a delay of 5 second
  });

  // Check Disable Selection every 1 second
  setInterval(fetchDisabledOptions, 1000);

  // Check Enable Selection every 1 second
  setInterval(fetchEnabledOptions, 1000);

  document.getElementById("confirm-btn").addEventListener("click", confirmSelection);

  function setInfo(eventInfos) {
    var eventNames = document.getElementById("event-name");
    var eventTime = document.getElementById("event-time");
    var eventPlace = document.getElementById("event-place");
    var eventHours = document.getElementById("event-hours");
    var eventNote = document.getElementById("event-note");
    const infoDiv = document.querySelector(".info");
    const eventInfo = infoDiv.querySelector(".event-info");

    eventNames.textContent = "活動名稱: " + eventInfos[0];
    eventTime.textContent = "活動時間: " + eventInfos[1];
    eventPlace.textContent = "活動地點: " + eventInfos[2];
    eventHours.textContent = "活動時數: " + eventInfos[3];
    eventNote.textContent = "備註: " + eventInfos[4];

    // Show the event info
    eventInfo.style.display = "block";
  }

  function confirmSelection() {
    event.preventDefault();
    const selectedValue = document.getElementById("selectbox").value;
    const username = document.getElementById("username").innerHTML;

    // Call the Google Apps Script function to handle the event
    if (selectedValue) {
      google.script.run
        .withSuccessHandler(onSuccess) // Callback for success
        .withFailureHandler(onFailure) // Callback for failure
        .eventConfirmClicked(username, selectedValue);
    } else {
      alert("Please select an event!");
    }
  }

  // Success handler after data is written to the sheet
  function onSuccess() {
    alert("Event selection confirmed!");
  }

  // Failure handler in case something goes wrong
  function onFailure(error) {
    alert("Error: " + error);
  }

  function fetchDisabledOptions() {
    // Call Google Apps Script function
    google.script.run.withSuccessHandler(disableOptions).getDisabledOptions();
  }

  function fetchEnabledOptions() {
    google.script.run.withSuccessHandler(enableOptions).getEnabledOptions();
  }

  function disableOptions(disabledValues) {
    // Loop through the values and disable the corresponding options
    disabledValues.forEach(function (value) {
      var optionToDisable = document.querySelector("#selectbox option[value='" + value + "']");
      if (optionToDisable) {
        optionToDisable.disabled = true;
      }
    });
  }

  function enableOptions(enabledValues) {
    enabledValues.forEach(function (value) {
      var optionToDisable = document.querySelector("#selectbox option[value='" + value + "']");
      if (optionToDisable && optionToDisable.disabled) {
        optionToDisable.disabled = false;
      }
    });
  }
</script>
